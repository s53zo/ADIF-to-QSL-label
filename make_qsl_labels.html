<!DOCTYPE html>
<html lang="en">
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PZCLRVBKKT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);} 
  gtag('js', new Date());
  gtag('config', 'G-PZCLRVBKKT');
</script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#ffffff" />
<title>ADIF to QSL Labels helper</title>
<style>
/* ===== Light & Dark Themes ===== */
:root{
--bg:#f8fafc; /* page background */
--panel:#ffffff; /* primary surface */
--panel-2:#f1f5f9; /* secondary surface */
--ink:#0f172a; /* text */
--muted:#64748b; /* secondary text */
--accent:#2563eb; /* brand */
--accent-2:#38bdf8; /* secondary brand */
--border:#e2e8f0; /* borders */
--ring:#3b82f6; /* focus ring */
--warn:#d97706; /* warning */
--good:#16a34a; /* success */
--shadow:0 4px 12px rgba(0,0,0,.08);
--radius:12px;
}
@media (prefers-color-scheme: dark){
:root{ --bg:#0f172a; --panel:#1e293b; --panel-2:#111827; --ink:#f8fafc; --muted:#94a3b8; --border:#334155; --shadow:0 8px 24px rgba(0,0,0,.4) }
}

body{margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Roboto, Helvetica, Arial; background:var(--bg); color:var(--ink)}
.app{display:grid; grid-template-columns: 380px 1fr; min-height:100vh}
aside{border-right:1px solid var(--border); background:var(--panel); padding:18px 20px; overflow:auto}
main{display:flex; flex-direction:column; height:100vh}

header{position:sticky; top:0; z-index:5; display:flex; gap:10px; padding:12px 16px; border-bottom:1px solid var(--border); align-items:center; background:var(--panel-2); box-shadow:var(--shadow)}
header h1{font-size:16px; font-weight:700; margin:0; color:var(--ink)}
header .spacer{flex:1}

.grid{display:grid; gap:14px}
.section{border:1px solid var(--border); border-radius:var(--radius); padding:14px; background:var(--panel); box-shadow:var(--shadow)}
.section h3{margin:0 0 10px 0; font-size:13px; color:var(--muted); text-transform:uppercase}

label{font-size:13px; color:var(--muted)}
input[type="text"], input[type="number"], input[type="date"], select, input[type="file"]{
width:100%; padding:9px 12px; border-radius:10px; border:1px solid var(--border); background:var(--panel-2); color:var(--ink);
}
input[type="text"]::placeholder{color:var(--muted)}
input:focus, select:focus{ outline:none; border-color:var(--ring); box-shadow:0 0 0 3px rgba(59,130,246,.3)}

button{border-radius:10px; padding:10px 14px; font-size:14px; border:1px solid var(--border); color:var(--ink); background:var(--panel-2); cursor:pointer; transition:all .2s}
button:hover{background:var(--accent); color:white; border-color:var(--accent)}
button.primary{background:var(--accent); color:white; border-color:var(--accent)}
button.primary:hover{background:#1d4ed8}

.tag{padding:2px 8px; border-radius:999px; background:var(--accent-2); color:#fff; font-size:11px; margin-left:8px}
.stats{font-size:12px; color:var(--muted); margin-left:12px}

canvas{background:#ffffff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow)}
.preview-wrap{padding:16px; overflow:auto; flex:1; background:var(--panel-2)}
.controls{display:flex; gap:10px; align-items:center}

.banner{margin:10px 16px 0 16px; padding:12px 14px; border-radius:10px; background:#e0f2fe; color:#0369a1; font-size:13px}
.warn{color:var(--warn); font-size:12px}
.good{color:var(--good); font-size:12px}

@media (max-width: 1200px){
.app{grid-template-columns:1fr}
aside{border-right:none; border-bottom:1px solid var(--border)}
}
/* === Contrast fixes (appended) === */
:root{ --panel:#101a2c; --panel-2:#0f2138; --ink:#eef3ff; --muted:#a9b4c6; --border:#2a3a53 }
body{ color-scheme: dark light }
header{ background: var(--panel) !important; box-shadow: var(--shadow) }
.section{ background: var(--panel-2) !important }
input[type="text"], input[type="number"], input[type="date"], select, input[type="file"]{ background: var(--panel-2) !important; color: var(--ink) !important; border-color: var(--border) !important }
#previewControls{ background: var(--panel) !important }
.banner{ background: var(--panel-2) !important; border-color: var(--border) !important; color: var(--ink) !important }
.tag{ background: var(--panel-2) !important; border:1px solid var(--border) !important; color:#bfe6ff !important }
.dialog{ background: var(--panel) !important }
button{ background: linear-gradient(180deg, #162943, #112236) !important }
</style>
</head>
<body>
<div class="app">
  <aside>
    <div class="grid">
      <div class="section">
        <h3>Data</h3>
        <div class="row">
          <label>ADIF file</label>
          <input id="adifFile" type="file" accept=".adi,.adif,.txt" />
        </div>
        <div id="adifWarning" class="warn">Sample data is shown. Upload your ADIF to replace it.</div>
      </div>

      <div class="section">
        <h3>Filters</h3>
        <div class="row2">
          <div>
            <label class="small muted">Date from</label>
            <input id="fDateFrom" type="date" />
          </div>
          <div>
            <label class="small muted">Date to</label>
            <input id="fDateTo" type="date" />
          </div>
        </div>
        <div class="row"><label>Bands (CSV)</label><input id="fBands" type="text" placeholder="e.g. 20M,40M"></div>
        <div class="row"><label>Modes (CSV)</label><input id="fModes" type="text" placeholder="e.g. CW,SSB,FT8"></div>
        <div class="row">
          <label>QSL field</label>
          <select id="fQslField">
            <option value="ANY" selected>Any of (QSL_RCVD / LOTW_QSL_RCVD / EQSL_QSL_RCVD)</option>
            <option value="QSL_RCVD">QSL_RCVD</option>
            <option value="LOTW_QSL_RCVD">LOTW_QSL_RCVD</option>
            <option value="EQSL_QSL_RCVD">EQSL_QSL_RCVD</option>
          </select>
        </div>
        <div class="row">
          <label>QSL status</label>
          <select id="fQslStatus">
            <option value="ALL" selected>All</option>
            <option value="N">Needed (N)</option>
            <option value="Y">Received (Y)</option>
            <option value="I">Ignore (I)</option>
            <option value="NONE">Not received (empty or N)</option>
          </select>
        </div>
        <p class="help">Filters apply live to preview & PDF.</p>
      </div>

      <div class="section">
        <h3>Page & Start Position</h3>
        <div class="row"><label>Page Size</label>
          <select id="pageSize">
            <option value="A4" selected>A4 (210×297mm)</option>
            <option value="LETTER">Letter (8.5×11")</option>
          </select>
        </div>
        <div class="row"><label>Cols</label><input id="cols" type="number" value="3" min="1"></div>
        <div class="row"><label>Rows</label><input id="rows" type="number" value="8" min="1"></div>
        <div class="row"><label>Label height (mm)</label><input id="labelH" type="number" step="0.1" value="33.8"></div>
        <div class="row"><label>Left margin (mm)</label><input id="marginL" type="number" step="0.1" value="3"></div>
        <div class="row"><label>Right margin (mm)</label><input id="marginR" type="number" step="0.1" value="3"></div>
        <div class="row"><label>Top margin (fixed)</label><input id="marginT" type="number" step="0.1" value="3" disabled></div>
        <div class="row2">
          <div>
            <label class="small muted">Start at row</label>
            <input id="startRow" type="number" min="1" value="1" />
          </div>
          <div>
            <label class="small muted">Start at column</label>
            <input id="startCol" type="number" min="1" value="1" />
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Offsets</h3>
        <div class="row"><label>Global X (mm)</label><input id="xOffset" type="number" step="0.1" value="0"></div>
        <div class="row"><label>Global Y (mm)</label><input id="yOffset" type="number" step="0.1" value="5"></div>
        <div class="row"><label>Per-column offsets (mm, CSV)</label><input id="colOffsets" type="text" value="0,0,0"></div>
        <div class="row"><label>Per-row offsets (mm, CSV)</label><input id="rowOffsets" type="text" value="0,0,0,0,0,0,0,0"></div>
        <p class="help">CSV lists auto-resize when you change columns/rows.</p>
      </div>

      <div class="section">
        <h3>Inside label</h3>
        <div class="row"><label>Padding X (mm)</label><input id="padX" type="number" step="0.1" value="2"></div>
        <div class="row"><label>Padding Y (mm)</label><input id="padY" type="number" step="0.1" value="2"></div>
        <div class="row"><label>Left footer text</label><input id="footerL" type="text" value="SY: Blondie, South Adriatic sea"></div>
        <div class="row"><label>Right footer text</label><input id="footerR" type="text" value="TNX & 73"></div>
        <div class="row"><label>Right footer shift (mm)</label><input id="footerRShift" type="number" step="0.1" value="5"></div>
        <div class="row"><label>Footer Y shift (mm)</label><input id="footerYShift" type="number" step="0.1" value="2"></div>
      </div>

      <div class="section">
        <h3>Table</h3>
        <div class="row"><label>Rows per label</label><input id="rowsPerLabel" type="number" min="1" value="4"></div>
        <div class="row"><label>Dynamic widths</label>
          <select id="dynamicCols">
            <option value="1" selected>On</option>
            <option value="0">Off (static)</option>
          </select>
        </div>
        <div class="row"><label>Shrink only</label>
          <select id="shrinkOnly">
            <option value="1" selected>On (leave free space)</option>
            <option value="0">Off (stretch to fill)</option>
          </select>
        </div>
        <div class="row"><label>Slack (pt)</label><input id="slackPt" type="number" step="0.1" value="2"></div>
        <div class="row"><label>Line gap (pt)</label><input id="lineGap" type="number" step="0.1" value="9"></div>

        <div class="columns" id="columns">
          <div class="muted">Columns (header + source). Defaults match Avery 3664.</div>
        </div>
        <div class="controls">
          <button id="addCol">+ Add column</button>
          <button id="resetCols">Reset to 3664 defaults</button>
        </div>
        <div class="muted" style="margin-top:8px">Min widths & Static widths (mm) match the number of columns:</div>
        <div class="row"><label>Min col widths (mm, CSV)</label><input id="minColMM" type="text" value="12,10,10,10,6"></div>
        <div class="row"><label>Static col widths (mm, CSV)</label><input id="staticColMM" type="text" value="20,12,12,18,8"></div>
      </div>

      <div class="section">
        <h3>Typography</h3>
        <div class="row">
          <label>Body font</label>
          <select id="fontBody">
            <option>Helvetica, Arial, sans-serif</option>
            <option>Arial, Helvetica, sans-serif</option>
            <option>Inter, Helvetica, Arial, sans-serif</option>
            <option>Roboto, Helvetica, Arial, sans-serif</option>
            <option>Times New Roman, Times, serif</option>
            <option>Georgia, Times, serif</option>
          </select>
        </div>
        <div class="row">
          <label>Mono font</label>
          <select id="fontMono">
            <option>Courier New, Courier, monospace</option>
            <option>Consolas, Monaco, monospace</option>
            <option>Menlo, Monaco, monospace</option>
            <option>Ubuntu Mono, monospace</option>
            <option>DejaVu Sans Mono, monospace</option>
          </select>
        </div>
        <div class="row">
          <label>Bold font</label>
          <select id="fontBold">
            <option>Helvetica, Arial, sans-serif</option>
            <option>Arial, Helvetica, sans-serif</option>
            <option>Inter, Helvetica, Arial, sans-serif</option>
            <option>Roboto, Helvetica, Arial, sans-serif</option>
            <option>Times New Roman, Times, serif</option>
            <option>Georgia, Times, serif</option>
          </select>
        </div>
        <div class="row"><label>To Radio (pt)</label><input id="sizeToRadio" type="number" step="0.1" value="7.5"></div>
        <div class="row"><label>Callsign (pt)</label><input id="sizeCallsign" type="number" step="0.1" value="14"></div>
        <div class="row"><label>Headers (pt)</label><input id="sizeHeaders" type="number" step="0.1" value="7.2"></div>
        <div class="row"><label>Rows (pt)</label><input id="sizeRows" type="number" step="0.1" value="8.2"></div>
        <div class="row"><label>Footer (pt)</label><input id="sizeFooter" type="number" step="0.1" value="7.2"></div>
      </div>

      <div class="section">
        <h3>Debug</h3>
        <div class="row"><label>Label outlines</label><select id="dbgOutline"><option value="0">Off</option><option value="1">On</option></select></div>
      </div>

      <div class="section">
        <h3>Config</h3>
        <div class="controls">
          <button id="saveCfg">Save config</button>
          <input id="loadCfg" type="file" accept=".json" />
        </div>
        <p class="help">Saves/loads JSON with all your settings (including columns & layout).</p>
      </div>
    </div>
  </aside>

  <main>
    <header>
      <a href="https://s53zo.github.io/ADIF-to-QSL-label/" style="margin-right: 10px;">
        <img src="https://s53zo.github.io/ADIF-to-QSL-label/ADIFtoQSL.jpg" alt="Logo" style="height: 100px; vertical-align: middle; border-radius: 6px;">
      </a>
      <h1>QSL Labels</h1>
      <span id="stats" class="stats">QSOs: 0 | Labels: 0 | Pages: 0</span>
      <div class="spacer"></div>
      <button id="downloadBtn" class="primary" disabled>Download PDF</button>
    </header>

    <div id="editorBar" class="editorbar" style="display:none">
      <span class="small muted">Visual Layout Editor</span>
      <span class="chip">Snap (mm):
        <select id="snapMM" style="width:auto">
          <option value="0">None</option>
          <option value="0.1">0.1</option>
          <option value="0.25" selected>0.25</option>
          <option value="0.5">0.5</option>
          <option value="1">1.0</option>
        </select>
      </span>
      <span class="chip"><label><input id="showGuides" type="checkbox" checked> Guides</label></span>
      <span class="chip"><label><input id="unlockCallX" type="checkbox"> Unlock Callsign X</label></span>
      <div class="spacer"></div>
      <button id="resetLayout">Reset</button>
      <button id="applyLayout" class="primary">Apply</button>
      <button id="closeEditor">Close</button>
    </div>

    <div id="banner" class="banner" style="display:none">
      <span class="good">Sample data loaded.</span>
      Upload your ADIF to use your own QSOs.
      <button id="reloadSample" class="link" title="Reload the built-in sample">Reload sample</button>
    </div>

    <div class="preview-wrap">
      <div id="previewControls" class="controls" style="margin-bottom:10px">
        <button id="prevPage">⟨</button>
        <span class="small" id="pageInfo">Page 1 / 1</span>
        <button id="nextPage">⟩</button>
        <div class="spacer"></div>
        <label class="small muted">Zoom</label>
        <input id="zoom" type="range" min="50" max="200" value="100" />
      </div>
      <canvas id="preview"></canvas>

      <canvas id="layoutEditor" style="display:none; margin-top:12px"></canvas>

      <p class="help">Preview is WYSIWYG: same math as the PDF. Use <b>Actual size / 100%</b> when printing the downloaded PDF.</p>
    </div>
  </main>
</div>

<div id="picker" class="overlay">
  <div class="dialog">
    <h4>Add column</h4>
    <div class="row">
      <div>
        <label class="small muted">Header</label>
        <input id="pickHeader" type="text" value="Header" />
      </div>
      <div>
        <label class="small muted">Source (ADIF tag)</label>
        <select id="pickSource"></select>
      </div>
    </div>
    <div class="actions">
      <button id="pickCancel">Cancel</button>
      <button id="pickOk" class="primary">Add</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/***** IMPORTANT: JavaScript logic kept IDENTICAL to preserve functionality. *****/
/* ===== Units & helpers ===== */
const MM = 72 / 25.4; const A4 = { w:210, h:297 }; const LETTER = { w:215.9, h:279.4 };
function mm2pt(mm){ return mm*MM; } function pt2mm(pt){ return pt/MM; }
function clamp(n,lo,hi){ return Math.max(lo, Math.min(hi,n)); }
function parseCSVfloats(s){ if(!s) return []; return s.split(",").map(x=>parseFloat(x.trim()||"0")); }
function parseCSVstrings(s){ if(!s) return []; return s.split(",").map(x=>x.trim().toUpperCase()).filter(Boolean); }
function downloadBlob(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); }
function setupHiDPICanvas(canvas, pageWpt, pageHpt, zoom){ const dpr=window.devicePixelRatio||1; const cssW=Math.round(pageWpt*zoom); const cssH=Math.round(pageHpt*zoom); canvas.style.width=cssW+"px"; canvas.style.height=cssH+"px"; canvas.width=Math.round(cssW*dpr); canvas.height=Math.round(cssH*dpr); const ctx=canvas.getContext('2d'); ctx.setTransform(canvas.width/pageWpt,0,0,canvas.height/pageHpt,0,0); return ctx; }

/* ===== ADIF parsing & helpers ===== */
const FIELD_TAG=/<([A-Za-z0-9_]+):(\d+)(?::[^>]+)?>/ig;
function parseADIF(text){
  if(!text) return [];
  const parts=text.replace(/\r\n?/g,"\n").split(/<eoh>/i);
  const body=parts.length>1?parts[1]:parts[0];
  const records=body.split(/<eor>/ig);
  const out=[];
  for(const rec of records){
    let m; let fields={};
    while((m=FIELD_TAG.exec(rec))!==null){
      const tag=m[1].toUpperCase(); const len=parseInt(m[2],10);
      const start=m.index+m[0].length; const val=rec.substr(start,len);
      fields[tag]=(val||"").trim();
    }
    if(Object.keys(fields).length) out.push(fields);
  }
  return out;
}
function fmtDate(s){ if(!s) return ""; s=s.trim(); return (s.length>=8&&/^\d{8}/.test(s))?`${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`:s; }
function fmtTime(s){ if(!s) return ""; s=s.trim(); return (s.length>=4&&/^\d{4}/.test(s))?`${s.slice(0,2)}:${s.slice(2,4)}`:s; }
function bandFromFreq(freq){ if(!freq) return ""; const f=parseFloat(freq); if(isNaN(f)) return ""; const B=[[1.8,2.0,"160M"],[3.5,4.0,"80M"],[5.3,5.406,"60M"],[7.0,7.3,"40M"],[10.1,10.15,"30M"],[14.0,14.35,"20M"],[18.068,18.168,"17M"],[21.0,21.45,"15M"],[24.89,24.99,"12M"],[28.0,29.7,"10M"],[50,54,"6M"],[70,71,"4M"],[144,148,"2M"],[420,450,"70CM"]]; for(const [lo,hi,b] of B){ if(f>=lo&&f<=hi) return b; } return ""; }
function normMode(mode,submode){ mode=(mode||"").toUpperCase().trim(); submode=(submode||"").toUpperCase().trim(); if(submode) return submode; if(mode==="USB"||mode==="LSB") return "SSB"; return mode; }
function qslValue(rec){ for(const k of ["QSL_RCVD","LOTW_QSL_RCVD","EQSL_QSL_RCVD"]){ if((rec[k]||"").toUpperCase()==="Y") return "TNX"; } return "PSE"; }

/* ===== Rows & filters ===== */
function buildRows(recs){
  const rows=[];
  for(const r of recs){
    const call=(r.CALL||"").toUpperCase().trim(); if(!call) continue;
    const date_raw=r.QSO_DATE||r.QSO_DATE_OFF||"";
    const time_raw=r.TIME_ON||r.TIME_OFF||"";
    rows.push({
      CALL:call, _DATE_RAW:date_raw, _TIME_RAW:time_raw,
      DATE:fmtDate(date_raw), TIME:fmtTime(time_raw),
      BAND:(r.BAND||"").toUpperCase().trim() || bandFromFreq(r.FREQ),
      MODE:normMode(r.MODE,r.SUBMODE),
      QSL:qslValue(r), ...r
    });
  }
  return rows;
}
function parseYMD(s){ if(!s) return null; const m=/(^(\d{4})-(\d{2})-(\d{2})$)/.exec(s); if(!m) return null; return s.replace(/-/g,''); }
function getQslFieldVal(rec, fieldSel){
  const up=(x)=>String(x||"").toUpperCase();
  if(fieldSel==="QSL_RCVD") return up(rec.QSL_RCVD);
  if(fieldSel==="LOTW_QSL_RCVD") return up(rec.LOTW_QSL_RCVD);
  if(fieldSel==="EQSL_QSL_RCVD") return up(rec.EQSL_QSL_RCVD);
  const a=[up(rec.QSL_RCVD),up(rec.LOTW_QSL_RCVD),up(rec.EQSL_QSL_RCVD)];
  return a.find(v=>v==="Y"||v==="N"||v==="I"||v==="R"||v==="V"||v==="E") || (a.find(v=>v)!=="") || "";
}
function rowPassesFilters(row, f){
  const d=row._DATE_RAW||"";
  if(f.from && (!d || d < f.from)) return false;
  if(f.to && (!d || d > f.to)) return false;
  if(f.bands && f.bands.size){ const b=(row.BAND||"").toUpperCase(); if(!f.bands.has(b)) return false; }
  if(f.modes && f.modes.size){ const m=(row.MODE||"").toUpperCase(); if(!f.modes.has(m)) return false; }
  if(f.qslStatus && f.qslStatus!=="ALL"){
    const val = getQslFieldVal(row, f.qslField);
    if(f.qslStatus==="N"){ if(val!=="N") return false; }
    else if(f.qslStatus==="Y"){ if(val!=="Y") return false; }
    else if(f.qslStatus==="I"){ if(val!=="I") return false; }
    else if(f.qslStatus==="NONE"){ if(val && val!=="N") return false; }
  }
  return true;
}

/* ===== Grouping & layout ===== */
function groupLabels(rows, rowsPerLabel){
  const by=new Map(); for(const r of rows){ if(!by.has(r.CALL)) by.set(r.CALL,[]); by.get(r.CALL).push(r); }
  for(const [k,arr] of by){ arr.sort((a,b)=>(a._DATE_RAW+a._TIME_RAW).localeCompare(b._DATE_RAW+b._TIME_RAW)); }
  const keys=[...by.keys()].sort();
  const labels=[]; for(const k of keys){ const arr=by.get(k); for(let i=0;i<arr.length;i+=rowsPerLabel){ labels.push([k, arr.slice(i,i+rowsPerLabel)]); } }
  return labels;
}

/* ===== Column sizing ===== */
const metricsCanvas=document.createElement('canvas'); metricsCanvas.width=1000; metricsCanvas.height=200;
const ctx2dForFonts=metricsCanvas.getContext('2d');
function measureText(ctx, text, font){ ctx.save(); ctx.font=font; const w=ctx.measureText(text||"").width; ctx.restore(); return w; }
function getCellText(row, source){ const key=(source||"").toUpperCase().trim(); if(!row) return ""; if(["DATE","TIME","BAND","MODE","QSL"].includes(key)) return row[key]||""; return row[key]||""; }
function computeColWidths(ctx, cfg, qsoRows, labelWpt){
  const cols=cfg.columns; const n=cols.length;
  const padXpt = mm2pt(cfg.padXmm ?? 0);
  const padTotal = padXpt * 2;
  const widths=cols.map(col=>{
    const headerW = measureText(ctx, col.header, `${cfg.sizeHeaders}px ${cfg.fontBold}`);
    return headerW + padTotal;
  });
  for(const row of qsoRows||[]){
    for(let i=0;i<n;i++){
      const txt=getCellText(row, cols[i].source);
      const cellW = measureText(ctx, txt, `${cfg.sizeRows}px ${cfg.fontMono}`) + padTotal;
      widths[i]=Math.max(widths[i], cellW);
    }
  }
  for(let i=0;i<n;i++) widths[i]+=cfg.colSlackPt;
  const minPts=cfg.minColMM.map(mm=>mm2pt(mm));
  for(let i=0;i<n;i++) widths[i]=Math.max(widths[i], minPts[i]||0);
  const total=widths.reduce((a,b)=>a+b,0);
  if(total<=0) return (cfg.staticColMM||[]).map(mm=>mm2pt(mm));
  if(cfg.shrinkOnly){ if(total>labelWpt){ const s=labelWpt/total; for(let i=0;i<n;i++) widths[i]*=s; } }
  else{ const s=labelWpt/total; for(let i=0;i<n;i++) widths[i]*=s; }
  return widths;
}

/* ===== Config & layout ===== */
let layoutState = null; // stores current layout (mm)
function defaultLayout(cfg){
  const labelW_mm = (cfg.pageWmm - (cfg.marginLmm + cfg.marginRmm)) / cfg.cols;
  const labelH_mm = cfg.labelHmm;
  const padX = cfg.padXmm, padY = cfg.padYmm;
  return {
    toRadio: { x_mm: padX, y_mm: padY + pt2mm(8) },
    callsign:{ y_mm: padY + pt2mm(8), centerX: true },
    headers: { y_mm: padY + pt2mm(20) },
    table:   { y_mm: padY + pt2mm(32), lineGapPt: cfg.lineGapPt },
    footerL: { x_mm: padX, y_mm: labelH_mm - padY - pt2mm(2) - cfg.footerYShiftmm },
    footerR: { x_mm: labelW_mm - padX - cfg.footerRShiftmm, y_mm: labelH_mm - padY - pt2mm(2) - cfg.footerYShiftmm }
  };
}
function pageDims(name){ return (name==="LETTER")?LETTER:A4; }
function readConfig(){
  const colRows=[...document.querySelectorAll('.col-row')];
  const columns=colRows.map(r=>({ header:r.querySelector('.col-h')?.value.trim()||"Col", source:r.querySelector('.col-s')?.value.trim()||"DATE" }));
  function fitCsv(csv,len,fill=0){ const arr=parseCSVfloats(csv); if(arr.length<len) arr.push(...Array(len-arr.length).fill(fill)); if(arr.length>len) arr.length=len; return arr; }
  const pm=document.getElementById('pageSize').value, dims=pageDims(pm);
  const cfg={
    pageSize:pm, pageWmm:dims.w, pageHmm:dims.h,
    cols:+(document.getElementById('cols').value||3),
    rows:+(document.getElementById('rows').value||8),
    labelHmm:parseFloat(document.getElementById('labelH').value||"33.8"),
    marginLmm:parseFloat(document.getElementById('marginL').value||"3"),
    marginRmm:parseFloat(document.getElementById('marginR').value||"3"),
    marginTmm:3,
    startRow: Math.max(1, parseInt(document.getElementById('startRow').value||"1",10)),
    startCol: Math.max(1, parseInt(document.getElementById('startCol').value||"1",10)),
    xOffmm:parseFloat(document.getElementById('xOffset').value||"0"),
    yOffmm:parseFloat(document.getElementById('yOffset').value||"5"),
    colOffsets:fitCsv(document.getElementById('colOffsets').value, +(document.getElementById('cols').value||3), 0),
    rowOffsets:fitCsv(document.getElementById('rowOffsets').value, +(document.getElementById('rows').value||8), 0),
    padXmm:parseFloat(document.getElementById('padX').value||"2"),
    padYmm:parseFloat(document.getElementById('padY').value||"2"),
    footerL:document.getElementById('footerL').value,
    footerR:document.getElementById('footerR').value,
    footerRShiftmm:parseFloat(document.getElementById('footerRShift').value||"5"),
    footerYShiftmm:parseFloat(document.getElementById('footerYShift').value||"2"),
    rowsPerLabel:+(document.getElementById('rowsPerLabel').value||4),
    dynamicCols:document.getElementById('dynamicCols').value==="1",
    shrinkOnly:document.getElementById('shrinkOnly').value==="1",
    colSlackPt:parseFloat(document.getElementById('slackPt').value||"2"),
    lineGapPt:parseFloat(document.getElementById('lineGap').value||"9"),
    columns,
    minColMM:fitCsv(document.getElementById('minColMM').value, columns.length, 8),
    staticColMM:fitCsv(document.getElementById('staticColMM').value, columns.length, 12),
    fontBody:document.getElementById('fontBody').value,
    fontMono:document.getElementById('fontMono').value,
    fontBold:document.getElementById('fontBold').value,
    sizeToRadio:parseFloat(document.getElementById('sizeToRadio').value||"7.5"),
    sizeCallsign:parseFloat(document.getElementById('sizeCallsign').value||"14"),
    sizeHeaders:parseFloat(document.getElementById('sizeHeaders').value||"7.2"),
    sizeRows:parseFloat(document.getElementById('sizeRows').value||"8.2"),
    sizeFooter:parseFloat(document.getElementById('sizeFooter').value||"7.2"),
    dbgOutline:document.getElementById('dbgOutline').value==="1",
    f:{
      from: parseYMD(document.getElementById('fDateFrom').value || ""),
      to:   parseYMD(document.getElementById('fDateTo').value || ""),
      bands: new Set(parseCSVstrings(document.getElementById('fBands').value)),
      modes: new Set(parseCSVstrings(document.getElementById('fModes').value)),
      qslField: document.getElementById('fQslField').value || "ANY",
      qslStatus: document.getElementById('fQslStatus').value || "ALL",
    }
  };
  if(!layoutState){ layoutState = defaultLayout(cfg); }
  else{ if(layoutState.table && (layoutState.table.lineGapPt==null)) layoutState.table.lineGapPt = cfg.lineGapPt; }
  cfg.layout = layoutState;
  document.getElementById('colOffsets').value = cfg.colOffsets.join(',');
  document.getElementById('rowOffsets').value = cfg.rowOffsets.join(',');
  document.getElementById('minColMM').value   = cfg.minColMM.join(',');
  document.getElementById('staticColMM').value= cfg.staticColMM.join(',');
  return cfg;
}

/* ===== Preview & PDF use layout ===== */
const canvas=document.getElementById('preview');
let recs=[], rows=[], labels=[]; let currentPage=0; let adifFields=[]; let usingSample=true;
function computeStats(cfg, baseRows, filteredRows){
  const per = cfg.cols * cfg.rows;
  const pages = Math.max(1, Math.ceil(labels.length / per));
  document.getElementById('pageInfo').textContent = `Page ${Math.min(currentPage+1,pages)} / ${pages}`;
  document.getElementById('stats').textContent = `QSOs: ${filteredRows.length} | Labels: ${labels.filter(l=>l && l[1] && l[1].length).length} | Pages: ${pages}`;
  document.getElementById('downloadBtn').disabled = (filteredRows.length===0);
  const warn = document.getElementById('adifWarning');
  const banner = document.getElementById('banner');
  if(usingSample){ warn.textContent = "Sample data is shown. Upload your ADIF to replace it."; warn.style.display="block"; banner.style.display="block"; }
  else{ warn.style.display="none"; banner.style.display="none"; }
}
function computeLabelX0Y0(cfg, col, rowI, labelWpt, labelHpt){
  const leftMarginPt=mm2pt(cfg.marginLmm);
  const topMarginPt=mm2pt(cfg.marginTmm);
  let x0=leftMarginPt + col*labelWpt;
  let y0=topMarginPt + rowI*labelHpt;
  x0 += mm2pt(cfg.xOffmm) + mm2pt(cfg.colOffsets[col]||0);
  y0 += mm2pt(cfg.yOffmm) + mm2pt(cfg.rowOffsets[rowI]||0);
  return {x0,y0};
}
function renderOnePage(cfg, pageIdx){
  const ctx = setupHiDPICanvas(canvas, mm2pt(cfg.pageWmm), mm2pt(cfg.pageHmm), (parseInt(document.getElementById('zoom').value||"100",10)/100));
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,mm2pt(cfg.pageWmm),mm2pt(cfg.pageHmm));
  ctx.fillStyle="#000"; ctx.textBaseline="alphabetic";
  const usableWmm=cfg.pageWmm - (cfg.marginLmm + cfg.marginRmm);
  const labelWpt=mm2pt(usableWmm / cfg.cols);
  const labelHpt=mm2pt(cfg.labelHmm);
  const perPage=cfg.cols*cfg.rows; const start=pageIdx*perPage; const end=Math.min(labels.length, start+perPage);
  const padXpt=mm2pt(cfg.padXmm), padYpt=mm2pt(cfg.padYmm);
  for(let idx=start; idx<end; idx++){
    const local=idx-start; const col=local % cfg.cols; const rowI=Math.floor(local / cfg.cols);
    const item=labels[idx];
    const isBlank = !item || !item[0] && (!item[1] || item[1].length===0);
    const call = isBlank ? "" : item[0];
    const chunk = isBlank ? [] : item[1];
    const {x0,y0}=computeLabelX0Y0(cfg,col,rowI,labelWpt,labelHpt);
    if(cfg.dbgOutline){ ctx.strokeStyle="#bbb"; ctx.lineWidth=0.5; ctx.strokeRect(x0,y0,labelWpt,labelHpt); }
    if(isBlank) continue;
    let colW;
    if(cfg.dynamicCols){
      colW = computeColWidths(metricsCanvas.getContext('2d'), {
        columns: cfg.columns, sizeHeaders: cfg.sizeHeaders, sizeRows: cfg.sizeRows,
        fontBold: cfg.fontBold, fontMono: cfg.fontMono, minColMM: cfg.minColMM,
        staticColMM: cfg.staticColMM, colSlackPt: cfg.colSlackPt, shrinkOnly: cfg.shrinkOnly,
        padXmm: cfg.padXmm,
      }, chunk, labelWpt);
    }else{
      const sum=cfg.staticColMM.reduce((a,b)=>a+b,0)||1;
      const scale=labelWpt / mm2pt(sum);
      colW=cfg.staticColMM.map(mm=>mm2pt(mm)*scale);
    }
    const L = cfg.layout; 
    ctx.font=`${cfg.sizeToRadio}px ${cfg.fontBody}`; ctx.textAlign="left";
    ctx.fillText("To Radio", x0 + mm2pt(L.toRadio.x_mm), y0 + mm2pt(L.toRadio.y_mm));
    ctx.font=`bold ${cfg.sizeCallsign}px ${cfg.fontBody}`;
    ctx.textAlign = (L.callsign.centerX && !document.getElementById('unlockCallX').checked) ? "center" : "left";
    const callXpt = (L.callsign.centerX && !document.getElementById('unlockCallX').checked)
      ? (x0 + labelWpt/2) : (x0 + mm2pt(L.callsign.x_mm ?? cfg.padXmm));
    ctx.fillText((call||"").toUpperCase(), callXpt, y0 + mm2pt(L.callsign.y_mm));
    ctx.textAlign="left";
    ctx.font=`bold ${cfg.sizeHeaders}px ${cfg.fontBold}`;
    let cx=x0; const headersY=y0 + mm2pt(L.headers.y_mm);
    for(let i=0;i<cfg.columns.length;i++){ ctx.fillText(cfg.columns[i].header, cx+padXpt, headersY); cx+=colW[i]; }
    const firstLineY=y0 + mm2pt(L.table.y_mm);
    const lineGap=(L.table.lineGapPt ?? cfg.lineGapPt);
    ctx.font=`${cfg.sizeRows}px ${cfg.fontMono}`;
    for(let r=0;r<cfg.rowsPerLabel;r++){
      const data=chunk[r]||null; let cx2=x0;
      for(let i=0;i<cfg.columns.length;i++){
        const maxW=Math.max(1, colW[i]-2*padXpt);
        const txt=data ? getCellText(data, cfg.columns[i].source) : "";
        shrinkAndDraw(ctx, txt, cx2+padXpt, firstLineY + r*lineGap, maxW, `${cfg.sizeRows}px ${cfg.fontMono}`);
        cx2+=colW[i];
      }
    }
    ctx.font=`${cfg.sizeFooter}px ${cfg.fontBody}`;
    ctx.textAlign="left";
    ctx.fillText(cfg.footerL, x0 + mm2pt(L.footerL.x_mm), y0 + mm2pt(L.footerL.y_mm));
    ctx.textAlign="right";
    ctx.fillText(cfg.footerR, x0 + mm2pt(L.footerR.x_mm), y0 + mm2pt(L.footerR.y_mm));
    ctx.textAlign="left";
  }
}
function shrinkAndDraw(ctx, text, x, y, maxW, font, minSize=5, step=0.3){
  let size=parseFloat(font.match(/(\d+(\.\d+)?)/)[0]); const family=font.replace(/^\s*\d+(\.\d+)?px\s*/,''); let w;
  while(true){ ctx.font=`${size}px ${family}`; w=ctx.measureText(text||"").width; if(w<=maxW || size<=minSize) break; size=Math.max(minSize,size-step); }
  ctx.fillText(text||"", x, y);
}

/* ===== Filters + Start-at offset ===== */
function applyFilters(allRows, f){ return allRows.filter(r=>rowPassesFilters(r, f)); }
function buildLabelsWithOffset(filteredRows, cfg){
  const grouped = groupLabels(filteredRows, cfg.rowsPerLabel);
  const skipSlots = Math.max(0, (cfg.startRow-1)*cfg.cols + (cfg.startCol-1));
  if(skipSlots===0) return grouped;
  const blanks = Array.from({length: skipSlots}, ()=> null);
  return blanks.concat(grouped);
}

/* ===== Recompute & PDF ===== */
function recompute(){
  const cfg=readConfig();
  const filtered = applyFilters(rows, cfg.f);
  labels = buildLabelsWithOffset(filtered, cfg);
  const per=cfg.cols*cfg.rows; const pages=Math.max(1, Math.ceil(labels.length/per));
  currentPage = clamp(currentPage, 0, pages-1);
  computeStats(cfg, rows, filtered);
  if(!editorMode){ renderOnePage(cfg, currentPage); }
}
async function downloadPDF(){
  const cfg=readConfig(); const filtered = applyFilters(rows, cfg.f);
  const pdfLabels = buildLabelsWithOffset(filtered, cfg);
  if(filtered.length===0){ alert("No QSOs match the current filters."); return; }
  const { jsPDF } = window.jspdf;
  const dims=pageDims(cfg.pageSize);
  const doc=new jsPDF({ unit:"mm", format:[dims.w,dims.h], compress:true });
  const labelWpt=mm2pt((cfg.pageWmm - (cfg.marginLmm + cfg.marginRmm)) / cfg.cols);
  const labelHpt=mm2pt(cfg.labelHmm);
  const per=cfg.cols*cfg.rows; const pages=Math.max(1, Math.ceil(pdfLabels.length/per));
  function pdfText(text,x_mm,y_mm,align="left",font="helvetica",style="normal",size=10){ doc.setFont(font,style); doc.setFontSize(size); doc.text(String(text??""),x_mm,y_mm,{align}); }
  function shrinkAndText(text,x_mm,y_mm,maxW_mm,font="courier",style="normal",startSize=8.2,minSize=5.0,step=0.3){ let sz=startSize; doc.setFont(font,style); doc.setFontSize(sz); while(doc.getTextWidth(String(text??""))>maxW_mm&&sz>minSize){ sz=Math.max(minSize,sz-step); doc.setFontSize(sz);} doc.text(String(text??""),x_mm,y_mm); }
  for(let p=0;p<pages;p++){
    if(p>0) doc.addPage([dims.w,dims.h],"portrait");
    const start=p*per, end=Math.min(pdfLabels.length, start+per);
    for(let idx=start; idx<end; idx++){
      const local=idx-start; const col=local%cfg.cols; const rowI=Math.floor(local/cfg.cols);
      const item=pdfLabels[idx];
      const isBlank = !item || !item[0] && (!item[1] || item[1].length===0);
      const {x0,y0} = computeLabelX0Y0(cfg,col,rowI,labelWpt,labelHpt);
      const x0_mm=pt2mm(x0), y0_mm=pt2mm(y0), labelW_mm=pt2mm(labelWpt), labelH_mm=pt2mm(labelHpt);
      const padX_mm=cfg.padXmm;
      if(cfg.dbgOutline){ doc.setDrawColor(187); doc.setLineWidth(0.1); doc.rect(x0_mm,y0_mm,labelW_mm,labelH_mm); doc.setDrawColor(0); }
      if(isBlank) continue;
      const [call, chunk]=item;
      let colWpt;
      if(cfg.dynamicCols){
        colWpt = computeColWidths(metricsCanvas.getContext('2d'), {
          columns: cfg.columns, sizeHeaders: cfg.sizeHeaders, sizeRows: cfg.sizeRows,
          fontBold: cfg.fontBold, fontMono: cfg.fontMono, minColMM: cfg.minColMM,
          staticColMM: cfg.staticColMM, colSlackPt: cfg.colSlackPt, shrinkOnly: cfg.shrinkOnly,
          padXmm: cfg.padXmm,
        }, chunk, labelWpt);
      }else{
        const sum=cfg.staticColMM.reduce((a,b)=>a+b,0)||1; const scale=labelWpt/mm2pt(sum);
        colWpt=cfg.staticColMM.map(mm=>mm2pt(mm)*scale);
      }
      const L = cfg.layout;
      pdfText("To Radio", x0_mm + L.toRadio.x_mm, y0_mm + L.toRadio.y_mm, "left", "helvetica", "normal", cfg.sizeToRadio);
      const callAlign = (L.callsign.centerX && !document.getElementById('unlockCallX').checked) ? "center" : "left";
      const callX_mm = (callAlign==="center") ? (x0_mm + labelW_mm/2) : (x0_mm + (L.callsign.x_mm ?? padX_mm));
      pdfText(String(call||"").toUpperCase(), callX_mm, y0_mm + L.callsign.y_mm, callAlign, "helvetica", "bold", cfg.sizeCallsign);
      let cx_pt=x0;
      for(let i=0;i<cfg.columns.length;i++){
        const x_mm=pt2mm(cx_pt + mm2pt(padX_mm));
        pdfText(cfg.columns[i].header, x_mm, y0_mm + L.headers.y_mm, "left", "helvetica", "bold", cfg.sizeHeaders);
        cx_pt += colWpt[i];
      }
      const firstLine_mm = y0_mm + L.table.y_mm;
      for(let r=0;r<cfg.rowsPerLabel;r++){
        const data=chunk[r]||null; let cx2_pt=x0;
        for(let i=0;i<cfg.columns.length;i++){
          const txt = data ? getCellText(data, cfg.columns[i].source) : "";
          const x_mm = pt2mm(cx2_pt + mm2pt(padX_mm));
          const y_mm = firstLine_mm + pt2mm((L.table.lineGapPt ?? cfg.lineGapPt) * r);
          const maxW_mm = Math.max(0.1, pt2mm(colWpt[i] - 2*mm2pt(padX_mm)));
          shrinkAndText(txt, x_mm, y_mm, maxW_mm, "courier", "normal", cfg.sizeRows);
          cx2_pt += colWpt[i];
        }
      }
      pdfText(cfg.footerL, x0_mm + L.footerL.x_mm, y0_mm + L.footerL.y_mm, "left", "helvetica", "normal", cfg.sizeFooter);
      pdfText(cfg.footerR, x0_mm + L.footerR.x_mm, y0_mm + L.footerR.y_mm, "right", "helvetica", "normal", cfg.sizeFooter);
    }
  }
  doc.save('qsl_labels_avery3664.pdf');
}

/* ===== Column UI & picker ===== */
function addColumnRow(header, source){
  const wrap=document.getElementById('columns');
  const row=document.createElement('div'); row.className='col-row';
  row.innerHTML=`<input class="col-h" type="text" placeholder="Header" value="${header||''}">
                 <select class="col-s"></select>
                 <button class="remove">✕</button>`;
  const sel=row.querySelector('.col-s');
  const defaults=["DATE","TIME","BAND","MODE","QSL"]; const seen=new Set();
  [...defaults, ...adifFields].forEach(tag=>{ if(!tag) return; const up=String(tag).toUpperCase(); if(seen.has(up)) return; seen.add(up); const opt=document.createElement('option'); opt.value=up; opt.textContent=up; sel.appendChild(opt); });
  if(source){ sel.value=String(source).toUpperCase(); }
  row.querySelector('.remove').onclick=()=>{ row.remove(); recompute(); };
  wrap.appendChild(row);
}
function resetDefaultColumns(){ const wrap=document.getElementById('columns'); wrap.innerHTML=""; [["Date","DATE"],["Time","TIME"],["Band","BAND"],["Mode","MODE"],["QSL","QSL"]].forEach(([h,s])=>addColumnRow(h,s)); }
function syncColArraysToDefaults(){ document.getElementById('minColMM').value="12,10,10,10,6"; document.getElementById('staticColMM').value="20,12,12,18,8"; }
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

/* ===== Sample data ===== */
function generateSampleRows(nLabels=10, maxRowsPerLabel=4){
  const calls=["9A3ST","K1ABC","G4XYZ","DL1AAA","EA7ZZ","I2QSL","F5HAM","OH2FIN","JA1DX","VK2CQ","ZS6RAD","LU5HAM"];
  const modes=["CW","SSB","FT8","FT4","RTTY"]; const bands=["20M","40M","30M","15M","10M","17M","12M","6M"];
  const today=new Date(); const pad=n=>String(n).padStart(2,"0"); const rows=[];
  for(let i=0;i<nLabels;i++){
    const call=calls[i%calls.length]; const rCount=Math.max(1, Math.floor(Math.random()*maxRowsPerLabel)+1);
    for(let r=0;r<rCount;r++){
      const d=new Date(today.getTime() - (i*3+r)*86400000);
      const date=`${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;
      const time=`${pad(12+((i+r)%10))}${pad((i*7+r*13)%60)}`;
      rows.push({ CALL:call, _DATE_RAW:date, _TIME_RAW:time, DATE:fmtDate(date), TIME:fmtTime(time),
                  BAND:bands[(i+r)%bands.length], MODE:modes[(i+r)%modes.length], QSL:(r%2===0?"TNX":"PSE") });
    }
  }
  return rows;
}
function loadSample(){
  const maxRows=+(document.getElementById('rowsPerLabel').value)||4;
  rows=generateSampleRows(10, maxRows);
  const tags=new Set(); rows.forEach(r=>Object.keys(r).forEach(k=>tags.add(k.toUpperCase())));
  adifFields=Array.from(tags).sort();
  usingSample=true;
  document.querySelectorAll('.col-row .col-s').forEach(sel=>{
    const keep=sel.value; sel.innerHTML=""; const defaults=["DATE","TIME","BAND","MODE","QSL"]; const seen=new Set();
    [...defaults, ...adifFields].forEach(tag=>{ if(!tag) return; const up=String(tag).toUpperCase(); if(seen.has(up)) return; seen.add(up); const opt=document.createElement('option'); opt.value=up; opt.textContent=up; sel.appendChild(opt); });
    if(keep) sel.value=keep;
  });
  currentPage=0; recompute();
}

/* ===== Layout editor ===== */
let editorMode = false;
const layoutCanvas = document.getElementById('layoutEditor');
let dragging = null; 
const handleSizePt = 20; 
function toggleEditor(on){
  editorMode = on;
  document.getElementById('editorBar').style.display = on ? "flex" : "none";
  layoutCanvas.style.display = on ? "block" : "none";
  document.getElementById('preview').style.display = on ? "none" : "block";
  document.getElementById('previewControls').style.display = on ? "none" : "flex";
  if(on){ renderEditor(); } else { recompute(); }
}
function currentLabelDims(cfg){
  const labelW_mm=(cfg.pageWmm - (cfg.marginLmm + cfg.marginRmm))/cfg.cols;
  const labelH_mm=cfg.labelHmm;
  return {labelW_mm,labelH_mm};
}
function renderEditor(){
  const cfg=readConfig();
  const {labelW_mm,labelH_mm}=currentLabelDims(cfg);
  const zoom=2;
  const ctx = setupHiDPICanvas(layoutCanvas, mm2pt(labelW_mm), mm2pt(labelH_mm), zoom);
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,mm2pt(labelW_mm),mm2pt(labelH_mm));
  ctx.strokeStyle="#bbb"; ctx.lineWidth=0.5; ctx.strokeRect(0,0,mm2pt(labelW_mm),mm2pt(labelH_mm));
  ctx.setLineDash([3,3]); ctx.strokeStyle="#d1d5db";
  ctx.strokeRect(mm2pt(cfg.padXmm), mm2pt(cfg.padYmm), mm2pt(labelW_mm-2*cfg.padXmm), mm2pt(labelH_mm-2*cfg.padYmm));
  ctx.setLineDash([]);
  const L=cfg.layout;
  ctx.fillStyle="#000";
  ctx.font=`${cfg.sizeToRadio}px ${cfg.fontBody}`; ctx.textAlign="left";
  ctx.fillText("To Radio", mm2pt(L.toRadio.x_mm), mm2pt(L.toRadio.y_mm));
  ctx.font=`bold ${cfg.sizeCallsign}px ${cfg.fontBody}`;
  const callXpt = (L.callsign.centerX && !document.getElementById('unlockCallX').checked)
    ? (mm2pt(labelW_mm)/2) : (mm2pt(L.callsign.x_mm ?? cfg.padXmm));
  ctx.textAlign = (L.callsign.centerX && !document.getElementById('unlockCallX').checked) ? "center" : "left";
  ctx.fillText("SAMPLECALL", callXpt, mm2pt(L.callsign.y_mm));
  ctx.textAlign="left";
  ctx.font=`bold ${cfg.sizeHeaders}px ${cfg.fontBold}`;
  ctx.fillText("Date   Time   Band   Mode   QSL", mm2pt(cfg.padXmm), mm2pt(L.headers.y_mm));
  ctx.font=`${cfg.sizeRows}px ${cfg.fontMono}`;
  ctx.fillText("2025-09-09  12:34  20M   CW   TNX", mm2pt(cfg.padXmm), mm2pt(L.table.y_mm));
  ctx.font=`${cfg.sizeFooter}px ${cfg.fontBody}`;
  ctx.fillText(cfg.footerL || "Left footer", mm2pt(L.footerL.x_mm), mm2pt(L.footerL.y_mm));
  ctx.textAlign="right";
  ctx.fillText(cfg.footerR || "TNX & 73", mm2pt(L.footerR.x_mm), mm2pt(L.footerR.y_mm));
  ctx.textAlign="left";
  drawHandle(ctx, mm2pt(L.toRadio.x_mm), mm2pt(L.toRadio.y_mm), "toRadio");
  drawHandle(ctx, callXpt,              mm2pt(L.callsign.y_mm), "callsign", (L.callsign.centerX && !document.getElementById('unlockCallX').checked) ? "y" : "xy");
  drawHandle(ctx, mm2pt(cfg.padXmm),    mm2pt(L.headers.y_mm), "headers", "y");
  drawHandle(ctx, mm2pt(cfg.padXmm),    mm2pt(L.table.y_mm),   "table",   "y");
  drawHandle(ctx, mm2pt(L.footerL.x_mm),mm2pt(L.footerL.y_mm), "footerL");
  drawHandle(ctx, mm2pt(L.footerR.x_mm),mm2pt(L.footerR.y_mm), "footerR");
  if(document.getElementById('showGuides').checked){
    ctx.fillStyle="#111827aa"; ctx.fillRect(6,6,160,64);
    ctx.fillStyle="#e5e7eb"; ctx.font="11px Arial";
    ctx.fillText("Drag the squares to move elements", 12, 22);
    ctx.fillText("Snap: hold Alt to disable", 12, 38);
    ctx.fillText("Callsign X locked unless unlocked", 12, 54);
  }
}
function drawHandle(ctx, xpt, ypt, key, lock="xy"){
  ctx.save();
  ctx.fillStyle="#38bdf8aa"; ctx.strokeStyle="#0284c7"; ctx.lineWidth=1;
  const hs=handleSizePt/2;
  ctx.fillRect(xpt-hs, ypt-hs, handleSizePt, handleSizePt);
  ctx.strokeRect(xpt-hs, ypt-hs, handleSizePt, handleSizePt);
  ctx.restore();
}
function hitTestHandle(cfg, xpt, ypt){
  const {labelW_mm} = currentLabelDims(cfg);
  const L=cfg.layout;
  const hs=handleSizePt/2;
  const callXpt = (L.callsign.centerX && !document.getElementById('unlockCallX').checked)
    ? (mm2pt(labelW_mm)/2) : (mm2pt(L.callsign.x_mm ?? cfg.padXmm));
  const handles = [
    {key:"toRadio", x:mm2pt(L.toRadio.x_mm), y:mm2pt(L.toRadio.y_mm), lock:"xy"},
    {key:"callsign",x:callXpt, y:mm2pt(L.callsign.y_mm), lock: (L.callsign.centerX && !document.getElementById('unlockCallX').checked)?"y":"xy"},
    {key:"headers", x:mm2pt(cfg.padXmm), y:mm2pt(L.headers.y_mm), lock:"y"},
    {key:"table",   x:mm2pt(cfg.padXmm), y:mm2pt(L.table.y_mm), lock:"y"},
    {key:"footerL", x:mm2pt(L.footerL.x_mm), y:mm2pt(L.footerL.y_mm), lock:"xy"},
    {key:"footerR", x:mm2pt(L.footerR.x_mm), y:mm2pt(L.footerR.y_mm), lock:"xy"},
  ];
  for(const h of handles){
    if(xpt>=h.x-hs && xpt<=h.x+hs && ypt>=h.y-hs && ypt<=h.y+hs) return h;
  }
  return null;
}
layoutCanvas.addEventListener('pointerdown', (e)=>{
  if(!editorMode) return;
  const cfg=readConfig();
  const dpr=layoutCanvas.width / layoutCanvas.style.width.replace("px",""); 
  const x = e.offsetX / dpr, y = e.offsetY / dpr;
  const hit = hitTestHandle(cfg, x, y);
  if(hit){
    dragging = { key:hit.key, lock:hit.lock, dx:x-hit.x, dy:y-hit.y };
    layoutCanvas.setPointerCapture(e.pointerId);
  }
});
layoutCanvas.addEventListener('pointermove', (e)=>{
  if(!editorMode || !dragging) return;
  const cfg=readConfig();
  const dpr=layoutCanvas.width / layoutCanvas.style.width.replace("px",""); 
  const x = e.offsetX / dpr, y = e.offsetY / dpr;
  const {labelW_mm,labelH_mm}=currentLabelDims(cfg);
  const L=cfg.layout;
  let nx = x - dragging.dx, ny = y - dragging.dy; 
  let x_mm = pt2mm(nx), y_mm = pt2mm(ny);
  const snap = parseFloat(document.getElementById('snapMM').value || "0.25");
  if(!e.altKey && snap>0){ x_mm = Math.round(x_mm/snap)*snap; y_mm = Math.round(y_mm/snap)*snap; }
  const xMin = cfg.padXmm, xMax = labelW_mm - cfg.padXmm;
  const yMin = cfg.padYmm, yMax = labelH_mm - cfg.padYmm;
  if(dragging.key==="toRadio"){
    if(dragging.lock!=="y") L.toRadio.x_mm = clamp(x_mm, xMin, xMax);
    if(dragging.lock!=="x") L.toRadio.y_mm = clamp(y_mm, yMin, yMax);
  }else if(dragging.key==="callsign"){
    if((L.callsign.centerX && !document.getElementById('unlockCallX').checked)){
      L.callsign.y_mm = clamp(y_mm, yMin, yMax);
    }else{
      L.callsign.x_mm = clamp(x_mm, xMin, xMax);
      L.callsign.y_mm = clamp(y_mm, yMin, yMax);
    }
  }else if(dragging.key==="headers"){
    L.headers.y_mm = clamp(y_mm, yMin, yMax);
  }else if(dragging.key==="table"){
    L.table.y_mm = clamp(y_mm, yMin, yMax);
  }else if(dragging.key==="footerL"){
    L.footerL.x_mm = clamp(x_mm, xMin, xMax);
    L.footerL.y_mm = clamp(y_mm, yMin, yMax);
  }else if(dragging.key==="footerR"){
    L.footerR.x_mm = clamp(x_mm, xMin, xMax);
    L.footerR.y_mm = clamp(y_mm, yMin, yMax);
  }
  layoutState = L; 
  renderEditor();
});
layoutCanvas.addEventListener('pointerup', (e)=>{ dragging=null; layoutCanvas.releasePointerCapture?.(e.pointerId); });
layoutCanvas.addEventListener('pointercancel', ()=>{ dragging=null; });

/* ===== UI wiring & boot ===== */
function applyConfigToUI(cfg){
  const map={ pageSize:'pageSize', cols:'cols', rows:'rows', labelHmm:'labelH', marginLmm:'marginL', marginRmm:'marginR',
    xOffmm:'xOffset', yOffmm:'yOffset', padXmm:'padX', padYmm:'padY', footerL:'footerL', footerR:'footerR',
    footerRShiftmm:'footerRShift', footerYShiftmm:'footerYShift', rowsPerLabel:'rowsPerLabel', colSlackPt:'slackPt',
    lineGapPt:'lineGap', sizeToRadio:'sizeToRadio', sizeCallsign:'sizeCallsign', sizeHeaders:'sizeHeaders', sizeRows:'sizeRows', sizeFooter:'sizeFooter',
    startRow:'startRow', startCol:'startCol'
  };
  for(const k in map){ if(cfg[k]!==undefined) document.getElementById(map[k]).value=cfg[k]; }
  if(cfg.fontBody) document.getElementById('fontBody').value=cfg.fontBody;
  if(cfg.fontMono) document.getElementById('fontMono').value=cfg.fontMono;
  if(cfg.fontBold) document.getElementById('fontBold').value=cfg.fontBold;
  if(cfg.colOffsets) document.getElementById('colOffsets').value = cfg.colOffsets.join(",");
  if(cfg.rowOffsets) document.getElementById('rowOffsets').value = cfg.rowOffsets.join(",");
  if(cfg.minColMM) document.getElementById('minColMM').value = cfg.minColMM.join(",");
  if(cfg.staticColMM) document.getElementById('staticColMM').value = cfg.staticColMM.join(",");
}
function autoResizeOffsetCSVs(){
  const cols=+(document.getElementById('cols').value||3);
  const rowsCount=+(document.getElementById('rows').value||8);
  function fitCsv(id,len){ const arr=parseCSVfloats(document.getElementById(id).value); if(arr.length<len) arr.push(...Array(len-arr.length).fill(0)); if(arr.length>len) arr.length=len; document.getElementById(id).value = arr.join(','); }
  fitCsv('colOffsets', cols); fitCsv('rowOffsets', rowsCount);
}
function bindInputs(){
  document.querySelectorAll('input,select,button').forEach(el=>{
    if(["adifFile","downloadBtn","saveCfg","loadCfg","addCol","resetCols","prevPage","nextPage","pickOk","pickCancel","reloadSample","editLayoutBtn","resetLayout","applyLayout","closeEditor"].includes(el.id)) return;
    el.addEventListener('input', debounce(()=>{ if(el.id==="cols"||el.id==="rows") autoResizeOffsetCSVs(); recompute(); },120));
    el.addEventListener('change', debounce(()=>{ if(el.id==="cols"||el.id==="rows") autoResizeOffsetCSVs(); recompute(); },120));
  });
  document.getElementById('zoom').addEventListener('input', recompute);
  document.getElementById('addCol').onclick=()=> openPicker();
  document.getElementById('resetCols').onclick=()=>{ resetDefaultColumns(); syncColArraysToDefaults(); recompute(); };
  document.getElementById('pickCancel').onclick=()=> closePicker();
  document.getElementById('pickOk').onclick=()=>{ const h=document.getElementById('pickHeader').value||"Header"; const s=document.getElementById('pickSource').value||"DATE"; addColumnRow(h,s); closePicker(); recompute(); };
  document.getElementById('prevPage').onclick=()=>{ const cfg=readConfig(); const per=cfg.cols*cfg.rows; const pages=Math.max(1,Math.ceil((labels?.length||0)/per)); currentPage=Math.max(0,currentPage-1); document.getElementById('pageInfo').textContent=`Page ${currentPage+1} / ${pages}`; renderOnePage(cfg, currentPage); };
  document.getElementById('nextPage').onclick=()=>{ const cfg=readConfig(); const per=cfg.cols*cfg.rows; const pages=Math.max(1,Math.ceil((labels?.length||0)/per)); currentPage=Math.min(pages-1,currentPage+1); document.getElementById('pageInfo').textContent=`Page ${currentPage+1} / ${pages}`; renderOnePage(cfg, currentPage); };
  document.getElementById('adifFile').addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return; const txt=await f.text();
    const recsRaw=parseADIF(txt); recs=recsRaw; rows=buildRows(recs);
    const tags=new Set(); recs.forEach(r=>Object.keys(r).forEach(k=>tags.add(k.toUpperCase())));
    adifFields=Array.from(tags).sort();
    usingSample=false; currentPage=0;
    document.querySelectorAll('.col-row .col-s').forEach(sel=>{
      const keep=sel.value; sel.innerHTML=""; const defaults=["DATE","TIME","BAND","MODE","QSL"]; const seen=new Set();
      [...defaults, ...adifFields].forEach(tag=>{ if(!tag) return; const up=String(tag).toUpperCase(); if(seen.has(up)) return; seen.add(up); const opt=document.createElement('option'); opt.value=up; opt.textContent=up; sel.appendChild(opt); });
      if(keep) sel.value=keep;
    });
    recompute();
    try {
      const uniqueCalls = new Set((rows||[]).map(r=>r.CALL)).size;
      gtag('event', 'adif_upload', {
        file_name: f.name,
        file_ext: (f.name.split('.').pop()||'').toLowerCase(),
        file_size_bytes: f.size || 0,
        qso_rows: rows?.length || 0,
        unique_calls: uniqueCalls,
        sample_data_used: usingSample ? 'yes' : 'no'
      });
    } catch(e){ /* no-op */ }
  });
  document.getElementById('downloadBtn').onclick=downloadPDF;
  document.getElementById('saveCfg').onclick=()=>{ const cfg=readConfig(); downloadBlob('qsl_config.json', new Blob([JSON.stringify(cfg,null,2)],{type:'application/json'})); };
  document.getElementById('loadCfg').addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return; const txt=await f.text(); try{ const obj=JSON.parse(txt); applyConfigToUI(obj); if(obj.layout) layoutState=obj.layout; autoResizeOffsetCSVs(); recompute(); }catch{ alert("Invalid config JSON"); }
  });
  document.getElementById('reloadSample').onclick=()=> loadSample();
  const editBtn=document.getElementById('editLayoutBtn');
  if(editBtn) editBtn.onclick=()=> toggleEditor(true);
  document.getElementById('resetLayout').onclick=()=>{ const cfg=readConfig(); layoutState = defaultLayout(cfg); renderEditor(); };
  document.getElementById('applyLayout').onclick=()=>{ toggleEditor(false); };
  document.getElementById('closeEditor').onclick=()=> toggleEditor(false);
}

/* ===== Column picker overlay ===== */
const picker=document.getElementById('picker');
function openPicker(){
  const select=document.getElementById('pickSource'); select.innerHTML="";
  const defaults=["DATE","TIME","BAND","MODE","QSL"]; const seen=new Set();
  [...defaults, ...adifFields].forEach(tag=>{ if(!tag) return; const up=String(tag).toUpperCase(); if(seen.has(up)) return; seen.add(up); const opt=document.createElement('option'); opt.value=up; opt.textContent=up; select.appendChild(opt); });
  document.getElementById('pickHeader').value="Header"; picker.style.display="flex";
}
function closePicker(){ picker.style.display="none"; }

/* ===== Boot ===== */
resetDefaultColumns();
syncColArraysToDefaults();
bindInputs();
loadSample();
</script>
</body>
</html>
